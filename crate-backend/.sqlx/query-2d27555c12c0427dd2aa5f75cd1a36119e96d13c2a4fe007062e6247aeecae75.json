{
  "db_name": "PostgreSQL",
  "query": "WITH r AS (\n    SELECT\n        user_id,\n        array_agg(role_id) AS roles\n    FROM\n        role_member\n    JOIN role ON role.room_id = $1\n        AND role_member.role_id = role.id\nGROUP BY\n    user_id\n)\nSELECT\n    m.room_id,\n    m.user_id,\n    m.membership AS \"membership: _\",\n    m.override_name,\n    m.override_description,\n    m.joined_at,\n    m.origin,\n    m.mute,\n    m.deaf,\n    m.timeout_until,\n    coalesce(r.roles, '{}') AS \"roles!\",\n    u.id as u_id,\n    u.version_id as u_version_id,\n    u.parent_id as u_parent_id,\n    u.name as u_name,\n    u.description as u_description,\n    u.avatar as u_avatar,\n    u.banner as u_banner,\n    u.system as u_system,\n    u.registered_at as u_registered_at,\n    u.deleted_at as u_deleted_at,\n    u.suspended as u_suspended,\n    a.owner_id as \"u_app_owner_id?\",\n    a.bridge as \"u_app_bridge?\",\n    a.public as \"u_app_public?\",\n    w.channel_id as \"u_webhook_channel_id?\",\n    w.creator_id as \"u_webhook_creator_id?\",\n    c.room_id as \"u_webhook_room_id?\",\n    p.external_platform as \"u_puppet_external_platform?\",\n    p.external_id as \"u_puppet_external_id?\",\n    p.external_url as \"u_puppet_external_url?\",\n    p.alias_id as \"u_puppet_alias_id?\"\nFROM\n    room_member m\n    JOIN usr u ON m.user_id = u.id\n    LEFT JOIN r ON r.user_id = m.user_id\n    LEFT JOIN application a ON u.id = a.id\n    LEFT JOIN webhook w ON u.id = w.id\n    LEFT JOIN channel c ON w.channel_id = c.id\n    LEFT JOIN puppet p on u.id = p.id\nWHERE\n    m.room_id = $1\n    AND m.membership = 'Join'\n    AND ($2::TEXT IS NULL\n        OR u.name ILIKE $2\n        OR m.override_name ILIKE $2)\n    AND (cardinality($4::uuid[]) = 0\n        OR r.roles @> $4)\n    AND ($5::TEXT IS NULL\n        OR m.origin ->> 'code' = $5)\n    AND ($6::BOOLEAN IS NULL\n        OR (\n            $6 = TRUE\n            AND m.timeout_until IS NOT NULL\n            AND m.timeout_until > now())\n        OR (\n            $6 = FALSE\n            AND (m.timeout_until IS NULL\n                OR m.timeout_until <= now())))\n    AND ($7::BOOLEAN IS NULL\n        OR m.mute = $7)\n    AND ($8::BOOLEAN IS NULL\n        OR m.deaf = $8)\n    AND ($9::BOOLEAN IS NULL\n        OR ($9 = TRUE\n            AND m.override_name IS NOT NULL)\n        OR ($9 = FALSE\n            AND m.override_name IS NULL))\n    AND ($10::BOOLEAN IS NULL\n        OR ($10 = TRUE\n            AND u.registered_at IS NULL)\n        OR ($10 = FALSE\n            AND u.registered_at IS NOT NULL))\n    AND ($11::timestamp IS NULL\n        OR m.joined_at < $11)\n    AND ($12::timestamp IS NULL\n        OR m.joined_at > $12)\n    AND ($13::timestamp IS NULL\n        OR extract_timestamp_from_uuid_v7(u.id) < $13)\n    AND ($14::timestamp IS NULL\n        OR extract_timestamp_from_uuid_v7(u.id) > $14)\nORDER BY\n    u.name\nLIMIT $3\n",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "room_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "user_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "membership: _",
        "type_info": {
          "Custom": {
            "name": "membership",
            "kind": {
              "Enum": [
                "Join",
                "Ban",
                "Leave"
              ]
            }
          }
        }
      },
      {
        "ordinal": 3,
        "name": "override_name",
        "type_info": "Text"
      },
      {
        "ordinal": 4,
        "name": "override_description",
        "type_info": "Text"
      },
      {
        "ordinal": 5,
        "name": "joined_at",
        "type_info": "Timestamp"
      },
      {
        "ordinal": 6,
        "name": "origin",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 7,
        "name": "mute",
        "type_info": "Bool"
      },
      {
        "ordinal": 8,
        "name": "deaf",
        "type_info": "Bool"
      },
      {
        "ordinal": 9,
        "name": "timeout_until",
        "type_info": "Timestamp"
      },
      {
        "ordinal": 10,
        "name": "roles!",
        "type_info": "UuidArray"
      },
      {
        "ordinal": 11,
        "name": "u_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 12,
        "name": "u_version_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 13,
        "name": "u_parent_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 14,
        "name": "u_name",
        "type_info": "Text"
      },
      {
        "ordinal": 15,
        "name": "u_description",
        "type_info": "Text"
      },
      {
        "ordinal": 16,
        "name": "u_avatar",
        "type_info": "Uuid"
      },
      {
        "ordinal": 17,
        "name": "u_banner",
        "type_info": "Uuid"
      },
      {
        "ordinal": 18,
        "name": "u_system",
        "type_info": "Bool"
      },
      {
        "ordinal": 19,
        "name": "u_registered_at",
        "type_info": "Timestamp"
      },
      {
        "ordinal": 20,
        "name": "u_deleted_at",
        "type_info": "Timestamp"
      },
      {
        "ordinal": 21,
        "name": "u_suspended",
        "type_info": "Jsonb"
      },
      {
        "ordinal": 22,
        "name": "u_app_owner_id?",
        "type_info": "Uuid"
      },
      {
        "ordinal": 23,
        "name": "u_app_bridge?",
        "type_info": "Bool"
      },
      {
        "ordinal": 24,
        "name": "u_app_public?",
        "type_info": "Bool"
      },
      {
        "ordinal": 25,
        "name": "u_webhook_channel_id?",
        "type_info": "Uuid"
      },
      {
        "ordinal": 26,
        "name": "u_webhook_creator_id?",
        "type_info": "Uuid"
      },
      {
        "ordinal": 27,
        "name": "u_webhook_room_id?",
        "type_info": "Uuid"
      },
      {
        "ordinal": 28,
        "name": "u_puppet_external_platform?",
        "type_info": "Text"
      },
      {
        "ordinal": 29,
        "name": "u_puppet_external_id?",
        "type_info": "Text"
      },
      {
        "ordinal": 30,
        "name": "u_puppet_external_url?",
        "type_info": "Text"
      },
      {
        "ordinal": 31,
        "name": "u_puppet_alias_id?",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Text",
        "Int8",
        "UuidArray",
        "Text",
        "Bool",
        "Bool",
        "Bool",
        "Bool",
        "Bool",
        "Timestamp",
        "Timestamp",
        "Timestamp",
        "Timestamp"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      true,
      true,
      false,
      true,
      false,
      false,
      true,
      null,
      false,
      false,
      true,
      false,
      true,
      true,
      true,
      false,
      true,
      true,
      true,
      false,
      false,
      false,
      false,
      true,
      true,
      true,
      false,
      true,
      true
    ]
  },
  "hash": "2d27555c12c0427dd2aa5f75cd1a36119e96d13c2a4fe007062e6247aeecae75"
}
