services:
  postgres:
    container_name: lamprey-postgres
    image: postgres:17
    user: "1000"
    volumes:
      - postgres:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      start_period: 30s
    environment:
      POSTGRES_PASSWORD: changeme
  backend:
    container_name: lamprey-backend
    image: git.celery.eu.org/lamprey/lamprey-backend:latest
    restart: unless-stopped
    command: serve
    depends_on:
      - postgres
    volumes:
      - ./config-backend.toml:/config.toml:ro
  media:
    container_name: lamprey-media
    image: git.celery.eu.org/lamprey/lamprey-media:latest
    restart: unless-stopped
    depends_on:
      - postgres
    volumes:
      - ./config-media.toml:/cdn.toml:ro
  bridge:
    container_name: lamprey-bridge
    image: git.celery.eu.org/lamprey/lamprey-bridge:latest
    restart: unless-stopped
    depends_on:
      - backend
    volumes:
      - bridge:/data
      - ./config-bridge.toml:/config.toml:ro
  proxy:
    container_name: lamprey-proxy
    build:
      context: caddy
      dockerfile: Dockerfile
    restart: unless-stopped
    volumes:
      - ./caddy:/etc/caddy:ro # copy Caddyfile here
      - ./static:/static:ro # copy static files here
      - caddy_data:/data
      - caddy_config:/config
volumes:
  postgres:
  bridge:
  caddy_data:
  caddy_config:
